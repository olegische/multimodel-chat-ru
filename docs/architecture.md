# Архитектура Multimodel Chat

## 1. Общий обзор
Multimodel Chat - это веб-приложение для взаимодействия с различными языковыми моделями (LLM), построенное на основе Next.js с использованием серверных компонентов и API-маршрутов.

## 2. Компоненты системы

### 2.1. Frontend

#### 2.1.1. Структура приложения
```
src/app/
├── api/                    # API Routes
│   ├── chat/              
│   │   └── route.ts       # Обработчик сообщений чата
│   └── messages/          
│       └── route.ts       # Получение истории сообщений
├── fonts/                 
│   ├── GeistMonoVF.woff   # Моноширинный шрифт для кода
│   └── GeistVF.woff       # Основной шрифт интерфейса
├── favicon.ico            # Иконка сайта
├── globals.css           # Глобальные стили и Tailwind
├── layout.tsx            # Корневой layout приложения
└── page.tsx             # Главная страница с чатом
```

#### 2.1.2. Компоненты
```
src/components/
├── ChatWindow.tsx          # Основное окно чата с сообщениями
├── GenerationSettings.tsx  # Настройки температуры и токенов
├── ModelSelector.tsx       # Выбор модели YandexGPT
├── Footer.tsx             # Ввод сообщений и настройки
├── Header.tsx             # Навигация и переключение темы
└── ThemeProvider.tsx      # Провайдер next-themes
```

#### 2.1.3. Основные компоненты

##### ChatWindow
- Отображение истории сообщений в формате диалога
- Автоматическая прокрутка к новым сообщениям
- Индикатор загрузки ответа
- Стилизация сообщений пользователя и ассистента
- Адаптивный дизайн с поддержкой темной темы

##### Footer
- Форма отправки сообщений
- Интеграция с GenerationSettings
- Управление состоянием ввода
- Валидация сообщений перед отправкой
- Блокировка во время генерации ответа

##### GenerationSettings
- Настройка температуры генерации (0-1)
- Управление количеством токенов (1-2000)
- Интерактивные слайдеры и инпуты
- Мгновенное применение настроек
- Поддержка disabled состояния

##### Header
- Брендинг приложения
- Интеграция с ModelSelector
- Переключатель темной/светлой темы
- Адаптивный дизайн
- Отложенный рендеринг для SSR

##### ModelSelector
- Выбор модели YandexGPT
- Отображение версии генерации
- Интеграция с YANDEX_GPT_MODELS
- Стилизация под тему приложения
- Поддержка disabled состояния

##### ThemeProvider
- Обертка next-themes
- Управление темой приложения
- Персистентность выбранной темы
- Поддержка системной темы
- SSR-совместимость

#### 2.1.4. Особенности реализации
- **Client Components**: Все компоненты используют 'use client' директиву
- **Типизация**: TypeScript для props и интерфейсов
- **Состояние**: 
  - React useState для локального состояния
  - next-themes для глобальной темы
- **Стилизация**: 
  - Tailwind CSS для адаптивного дизайна
  - Поддержка темной/светлой темы
  - Responsive дизайн

#### 2.1.5. API Endpoints
- **POST /api/chat**: Отправка сообщений и получение ответов от LLM
- **GET /api/messages**: Получение истории сообщений чата

### 2.2. Backend

#### 2.2.1. API Routes
- **Chat API** (`api/chat/route.ts`):
  - POST-обработчик сообщений чата
  - Валидация входящих данных через Zod
  - Управление контекстом беседы
  - Интеграция с YandexGPT
  - Сохранение сообщений в БД

- **Messages API** (`api/messages/route.ts`):
  - GET-обработчик истории сообщений
  - Фильтрация по chatId
  - Сортировка по timestamp
  - Force-dynamic режим для актуальных данных

#### 2.2.2. Библиотечные модули
```
src/lib/
├── db.ts          # Инициализация Prisma Client
└── yandexGpt.ts   # Интеграция с Yandex GPT API
```

- **db.ts**: 
  - Singleton паттерн для Prisma Client
  - Глобальный кэш для режима разработки
  - Типизация через PrismaClient

- **yandexGpt.ts**:
  - Конфигурация доступных моделей YandexGPT
  - Типизация запросов и ответов
  - Валидация через Zod
  - Управление контекстом сообщений
  - Обработка ошибок API

#### 2.2.3. Модели YandexGPT
```typescript
const YANDEX_GPT_MODELS = {
  'YandexGPT Lite Latest': { generation: 3 },
  'YandexGPT Lite RC': { generation: 4 },
  'YandexGPT Pro Latest': { generation: 3 },
  'YandexGPT Pro RC': { generation: 4 },
  'YandexGPT Pro 32k RC': { generation: 4 }
}
```

#### 2.2.4. Валидация данных
- **Входящие запросы**:
  ```typescript
  const chatRequestSchema = z.object({
    message: z.string().min(1),
    model: z.string(),
    temperature: z.number().min(0).max(1),
    maxTokens: z.number().min(1).max(2000),
    chatId: z.string().optional()
  });
  ```

#### 2.2.5. Обработка ошибок
- Валидация входящих данных
- Обработка ошибок API
- Логирование ошибок
- Типизированные ответы

#### 2.2.3. База данных
- **ORM**: Prisma
- **База данных**: SQLite
- **Схема данных**:
  ```
  Chat (1) --- (n) Message
  ```

## 3. Основные модули

### 3.1. Модуль чата
- `src/app/api/chat/route.ts` - обработка сообщений чата
- `src/app/api/messages/route.ts` - получение истории сообщений
- `src/lib/yandexGpt.ts` - интеграция с Yandex GPT

### 3.2. Модуль базы данных
- `src/lib/db.ts` - инициализация Prisma Client
- `prisma/schema.prisma` - схема базы данных
- Миграции Prisma для управления структурой БД

### 3.3. Модуль тестирования
- Jest для модульных тестов
- Тестирование API endpoints
- Тестирование интеграции с базой данных

## 4. Развертывание

### 4.1. Контейнеризация
- Dockerfile для сборки образа
- Multi-stage builds для оптимизации
- Поддержка различных архитектур (AMD64/ARM64)

### 4.2. Инфраструктура
- Docker для контейнеризации
- Nginx как reverse proxy
- Container Registry (Yandex Cloud) для хранения образов

## 5. Безопасность

### 5.1. Защита API
- Валидация входящих данных через Zod
- Защита от инъекций через Prisma
- Rate limiting (планируется)

### 5.2. Инфраструктурная безопасность
- fail2ban для защиты от сканирования
- HTTPS через Nginx
- Безопасное хранение переменных окружения

## 6. Масштабирование

### 6.1. Текущие возможности
- Горизонтальное масштабирование через Docker
- Кэширование ответов API
- Оптимизация запросов к базе данных

### 6.2. Планируемые улучшения
- Интеграция с GigaChat
- Поддержка множества LLM провайдеров
- Система пользователей и авторизации

## 7. Мониторинг и логирование
- Логирование через Docker
- Мониторинг состояния контейнеров
- Отслеживание ошибок API

## 8. Процесс разработки
- Git для версионирования
- Conventional Commits
- Документация в формате Markdown
- SOP для релизов и развертывания

## 9. Зависимости
```json
{
  "core": {
    "next": "14.x",
    "react": "18.x",
    "prisma": "5.22.0"
  },
  "api": {
    "zod": "3.x"
  },
  "dev": {
    "typescript": "5.x",
    "jest": "29.x"
  }
}
```

## 10. Требования к окружению
- Node.js 20.x
- Docker
- Git
- SQLite
- Nginx